<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mind Elixir Renderer</title>
    <style>
        @import 'https://cdn.jsdelivr.net/npm/mind-elixir/dist/style.css';

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
        }

        /* Light theme overrides */
        :root {
            --main-color: #333;
            --main-bgcolor: #ffffff;
            --color: #666;
            --bgcolor: #f5f5f5;
        }

        .mind-elixir {
            background: #ffffff !important;
        }

        .mind-elixir .map-canvas {
            background: #fafafa !important;
        }

        .mind-elixir .mind-elixir-toolbar {
            background: #ffffff !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .mind-elixir .node {
            background: #ffffff !important;
            color: #333 !important;
            border: 1px solid #d0d0d0 !important;
        }

        .mind-elixir .node.selected {
            background: #e3f2fd !important;
            border-color: #2196f3 !important;
        }
    </style>
</head>

<body>
    <div id="status">Loading...</div>
    <div id="map"></div>

    <script type="module" src="https://cdn.jsdelivr.net/npm/mind-elixir/dist/MindElixir.js"></script>

    <script type="module">
        import MindElixir from 'https://cdn.jsdelivr.net/npm/mind-elixir/dist/MindElixir.js';

        const statusEl = document.getElementById('status');
        let mind = null;
        let isUpdatingFromParent = false;

        function updateStatus(message) {
            statusEl.textContent = message;
            console.log('[Mind Elixir Renderer]', message);
        }

        // Convert markdown to Mind Elixir format (for backward compatibility)
        function parseMarkdownToMindElixir(markdown) {
            if (!markdown || markdown.trim() === '') {
                return {
                    nodeData: { id: 'root', topic: 'Empty Mindmap' },
                    linkData: {}
                };
            }

            const lines = markdown.split('\n');
            const root = { id: 'root', topic: 'Mindmap', children: [] };
            const stack = [{ level: 0, node: root }];
            let id = 1;

            lines.forEach(line => {
                const trimmed = line.trim();
                if (!trimmed) return;

                let level = 0;
                let topic = '';

                if (trimmed.startsWith('#')) {
                    const match = trimmed.match(/^(#+)\s+(.*)/);
                    if (match) {
                        level = match[1].length;
                        topic = match[2];
                    }
                } else if (trimmed.startsWith('-')) {
                    const indentMatch = line.match(/^(\s*)-/);
                    const indent = indentMatch ? indentMatch[1].length : 0;
                    level = Math.floor(indent / 2) + 2;
                    topic = trimmed.replace(/^-\s+/, '');
                } else {
                    topic = trimmed;
                    level = stack[stack.length - 1].level + 1;
                }

                if (!topic) return;

                const newNode = {
                    id: `node_${id++}`,
                    topic: topic,
                    children: []
                };

                while (stack.length > 0 && stack[stack.length - 1].level >= level) {
                    stack.pop();
                }

                if (stack.length > 0) {
                    const parent = stack[stack.length - 1].node;
                    if (!parent.children) parent.children = [];
                    parent.children.push(newNode);
                    stack.push({ level, node: newNode });
                }
            });

            if (root.children && root.children.length === 1) {
                const firstChild = root.children[0];
                firstChild.id = 'root';
                return { nodeData: firstChild, linkData: {} };
            }

            return { nodeData: root, linkData: {} };
        }

        function renderMindmap(content) {
            try {
                updateStatus('Rendering mindmap...');

                if (!content || content.trim() === '') {
                    updateStatus('No content');
                    return;
                }

                let data;

                // Try to parse as JSON first (new format)
                try {
                    data = JSON.parse(content);
                    // Validate it's Mind Elixir format
                    if (!data.nodeData) {
                        throw new Error('Not Mind Elixir format');
                    }
                } catch (e) {
                    // If not JSON, treat as markdown (backward compatibility)
                    console.log('Converting markdown to Mind Elixir format');
                    data = parseMarkdownToMindElixir(content);
                }

                isUpdatingFromParent = true;

                if (!mind) {
                    const options = {
                        el: '#map',
                        direction: MindElixir.SIDE,
                        draggable: true,
                        toolBar: true,
                        nodeMenu: true,
                        keypress: true,
                        locale: 'en',
                        overflowHidden: false,
                        contextMenu: true,
                        contextMenuOption: {
                            focus: true,
                            link: true,
                            extend: [
                                {
                                    name: 'Add Summary',
                                    onclick: () => {
                                        // Mind Elixir doesn't have a direct createSummary API exposed easily in all versions,
                                        // but let's try the standard way if available, or fallback to adding a child node styled as summary.
                                        // Checking documentation/source, createSummary might be available.
                                        // If not, we can simulate it or just add a node.
                                        // For now, let's assume standard behavior or add a child.
                                        // Actually, Mind Elixir usually has a 'summary' feature.
                                        // Let's try to trigger it via data manipulation if API is missing.
                                        // But wait, the library should handle it.
                                        // Let's check if we can access the internal method or just use a workaround.
                                        // Since we are using the CDN version, let's try to use the instance method if it exists.
                                        // If not, we'll just add a child node with a specific style/tag.
                                        // Actually, let's just use the built-in 'summary' if it's in the default menu, but we are customizing it.
                                        // If we customize 'extend', we keep default options if we don't overwrite 'contextMenuOption'.
                                        // But we are overwriting it.
                                        // Let's add a custom implementation for summary if needed.
                                        // For now, let's use a simple child node as summary.
                                        const node = mind.currentNode;
                                        if (node) {
                                            // mind.createSummary(node.nodeObj.id); // If this exists
                                            // If not, let's just add a child.
                                            // Actually, let's look at the docs or common usage.
                                            // Mind Elixir 2.x supports summary.
                                            // Let's try to find the method.
                                            // It seems it might be `createSummary`.
                                            // Let's try it safely.
                                            try {
                                                mind.createSummary(node.nodeObj.id);
                                            } catch (e) {
                                                console.warn('createSummary not supported, adding child instead');
                                                mind.addChild(node);
                                            }
                                        }
                                    }
                                },
                                {
                                    name: 'Insert Image',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const url = prompt('Enter Image URL:');
                                            if (url) {
                                                const topic = node.nodeObj.topic;
                                                const newTopic = `${topic}\n![Image](${url})`;
                                                mind.reshapeNode(node, newTopic);
                                            }
                                        }
                                    }
                                },
                                {
                                    name: 'Insert Link',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const url = prompt('Enter URL:');
                                            if (url) {
                                                const topic = node.nodeObj.topic;
                                                // Markdown link
                                                const newTopic = `[${topic}](${url})`;
                                                mind.reshapeNode(node, newTopic);
                                            }
                                        }
                                    }
                                },
                                {
                                    name: 'Bold Text',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const topic = node.nodeObj.topic;
                                            mind.reshapeNode(node, `<b>${topic}</b>`);
                                        }
                                    }
                                },
                                {
                                    name: 'Italic Text',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const topic = node.nodeObj.topic;
                                            mind.reshapeNode(node, `<i>${topic}</i>`);
                                        }
                                    }
                                },
                                {
                                    name: 'Add Icon',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const icons = ['ðŸ“Œ', 'ðŸ’¡', 'âœ…', 'âŒ', 'ðŸ“…', 'ðŸ“', 'ðŸš©', 'â­'];
                                            const icon = prompt(`Choose an icon:\n${icons.join(' ')}`, icons[0]);
                                            if (icon) {
                                                const currentIcons = node.nodeObj.icons || [];
                                                mind.updateNodeIcons(node.nodeObj.id, [...currentIcons, icon]);
                                            }
                                        }
                                    }
                                },
                                {
                                    name: 'Add Tag',
                                    onclick: () => {
                                        const node = mind.currentNode;
                                        if (node) {
                                            const tag = prompt('Enter Tag Name:');
                                            if (tag) {
                                                const currentTags = node.nodeObj.tags || [];
                                                mind.updateNodeTags(node.nodeObj.id, [...currentTags, tag]);
                                            }
                                        }
                                    }
                                }
                            ]
                        }
                    };

                    mind = new MindElixir(options);
                    mind.init(data);

                    // Listen for operations only
                    mind.bus.addListener('operation', (operation) => {
                        if (!isUpdatingFromParent) {
                            console.log('Operation:', operation.name);
                            setTimeout(() => {
                                const currentData = mind.getData();
                                const jsonString = JSON.stringify(currentData);
                                window.parent.postMessage({
                                    type: 'MINDMAP_UPDATED',
                                    content: jsonString
                                }, '*');
                            }, 200);
                        }
                    });
                } else {
                    mind.refresh(data);
                }

                setTimeout(() => {
                    isUpdatingFromParent = false;
                }, 300);

                updateStatus(`Rendered (${content.length} chars)`);

                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 2000);
            } catch (error) {
                updateStatus('Error: ' + error.message);
                console.error('[Mind Elixir Renderer] Error:', error);
                isUpdatingFromParent = false;
            }
        }

        // Listen for messages from parent window
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'UPDATE_MINDMAP') {
                renderMindmap(event.data.content);
            }
        });

        // Signal ready
        updateStatus('Ready');
        if (window.parent !== window) {
            window.parent.postMessage({ type: 'MINDMAP_READY' }, '*');
        }
    </script>
</body>

</html>